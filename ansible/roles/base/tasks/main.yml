- name: 必要パッケージをインストール
  apt:
    name:
      - git
      - curl
      - ca-certificates
      - gnupg
      - lsb-release
      - ufw
    update_cache: true
    state: present

- name: deployユーザーをsudoグループに追加
  user:
    name: deploy
    groups: sudo
    append: true

- name: deployユーザーがパスワードなしでsudoを使えるように設定
  lineinfile:
    path: /etc/sudoers.d/deploy
    line: "deploy ALL=(ALL) NOPASSWD: ALL"
    create: true
    mode: "0440"
    validate: "visudo -cf %s"

- name: UFWのデフォルトポリシーを設定
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }

- name: UFWで必要ポートを許可
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: ["22", "80", "443"]

- name: UFWを有効化
  ufw:
    state: enabled

- name: 作業ディレクトリ作成
  file:
    path: "{{ item }}"
    state: directory
    owner: deploy
    group: deploy
    mode: "0755"
  loop:
    - /opt/chat
    - /opt/chat-preview
    - /opt/backups
