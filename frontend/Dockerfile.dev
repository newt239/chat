FROM node:20-alpine

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@10.19.0 --activate

# Copy workspace configuration
COPY pnpm-workspace.yaml package.json ./
COPY pnpm-lock.yaml ./

# Copy all workspace package.json files to satisfy pnpm workspace
COPY frontend/package.json ./frontend/
COPY backend/package.json ./backend/

# Install all dependencies
RUN pnpm install --frozen-lockfile

# Copy frontend source code
COPY frontend ./frontend

WORKDIR /app/frontend

# Expose port
EXPOSE 5173

# Run dev server (install dependencies first in case volumes are empty)
CMD ["sh", "-c", "pnpm install --frozen-lockfile && pnpm dev --host 0.0.0.0"]
