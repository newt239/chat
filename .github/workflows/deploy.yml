name: Deploy to ConoHa VPS

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "preview/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: デプロイ環境を判定
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "host=${{ secrets.PRODUCTION_HOST }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.PRODUCTION_SSH_PORT }}" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME=$(echo ${{ github.ref }} | sed 's/refs\/heads\///g' | sed 's/\//-/g')
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
            echo "host=${{ secrets.PREVIEW_HOST }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.PREVIEW_SSH_PORT }}" >> $GITHUB_OUTPUT
          fi

      - name: Python/Ansible をセットアップ
        run: |
          python3 -m pip install --user pipx
          ~/.local/bin/pipx ensurepath
          ~/.local/bin/pipx install ansible-core
          ~/.local/bin/pipx inject ansible-core jmespath
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Ansible コレクションをインストール
        run: |
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: SSH秘密鍵を設定
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ steps.env.outputs.port }} -H ${{ steps.env.outputs.host }} >> ~/.ssh/known_hosts

      - name: 本番へデプロイ（Ansible）
        if: ${{ steps.env.outputs.environment == 'production' }}
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          WASABI_ACCESS_KEY_ID: ${{ secrets.WASABI_ACCESS_KEY_ID }}
          WASABI_SECRET_ACCESS_KEY: ${{ secrets.WASABI_SECRET_ACCESS_KEY }}
          WASABI_BUCKET_NAME: ${{ secrets.WASABI_BUCKET_NAME }}
          WASABI_REGION: ${{ secrets.WASABI_REGION }}
          WASABI_ENDPOINT: ${{ secrets.WASABI_ENDPOINT }}
        run: |
          ansible-playbook -i ansible/inventory/production.ini ansible/playbooks/site.yml

      - name: プレビューへデプロイ（Ansible）
        if: ${{ steps.env.outputs.environment == 'preview' }}
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          WASABI_ACCESS_KEY_ID: ${{ secrets.WASABI_ACCESS_KEY_ID }}
          WASABI_SECRET_ACCESS_KEY: ${{ secrets.WASABI_SECRET_ACCESS_KEY }}
          WASABI_BUCKET_NAME: ${{ secrets.WASABI_BUCKET_NAME }}
          WASABI_REGION: ${{ secrets.WASABI_REGION }}
          WASABI_ENDPOINT: ${{ secrets.WASABI_ENDPOINT }}
        run: |
          BRANCH_NAME="${{ steps.env.outputs.branch_name }}"
          # 低衝突なポートを算出（範囲: +1〜+400）
          N=$(echo -n "$BRANCH_NAME" | cksum | awk '{print $1%400+1}')
          PREVIEW_PORT=$((10080 + N))
          CADDY_HTTP_PORT=$((18000 + N))
          CADDY_HTTPS_PORT=$((18400 + N))
          PREVIEW_DOMAIN="preview-${BRANCH_NAME}.${{ secrets.PRODUCTION_DOMAIN }}"

          ansible-playbook -i ansible/inventory/production.ini ansible/playbooks/preview.yml \
            --extra-vars "branch=$BRANCH_NAME preview_port=$PREVIEW_PORT caddy_http_port=$CADDY_HTTP_PORT caddy_https_port=$CADDY_HTTPS_PORT preview_domain=$PREVIEW_DOMAIN"

      - name: デプロイ完了通知
        if: success()
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "✅ 本番環境へのデプロイが完了しました"
            echo "URL: https://${{ secrets.PRODUCTION_DOMAIN }}"
          else
            echo "✅ プレビュー環境へのデプロイが完了しました"
            echo "ブランチ: ${{ steps.env.outputs.branch_name }}"
          fi

      - name: デプロイ失敗通知
        if: failure()
        run: |
          echo "❌ デプロイに失敗しました"
          echo "ログを確認してください"
