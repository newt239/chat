## WebSocket リアルタイム通知仕様

### 1. 接続時のチャンネル情報

- クライアント（ユーザー）は**現在“参加中”のチャンネル ID 一覧**の情報をサーバへ渡す（例：接続時または`join_channel`/`leave_channel`イベントで購読チャンネルをサーバに通知）。
- サーバー側はこのチャンネル購読情報を**各ユーザーごとに記録・管理**する。

### 2. イベント配信方針

#### (A) タイピング通知（`typing`/`stop_typing`等）

- **「現在参加中（購読中）」のチャンネルのみ**で、**そのチャンネルに参加しているユーザーにだけ**タイピング中情報を配信する。
- 例：A さんが #general で typing → #general を購読している B, C, ...だけに typing イベント。

#### (B) 新着メッセージ・編集・削除（`new_message`/`message_updated`/`message_deleted`等）

- ユーザーが「セッション中に参加しているすべてのチャンネル」が配信対象
- どのチャンネルで発生したものであっても、そのユーザーが現在購読しているチャンネルについては**全て**受信する。
  - 今フォーカスしているタブかどうかには関係なく、購読中の全チャンネルを対象とする。
  - ※これにより「裏で開いているチャンネルの新着」も通知バッジ等で即時反映可能

#### (C) 未参加のチャンネル

- 参加・購読していないチャンネルのイベント（typing 含む・新着/編集/削除含む）は配信しない。

## サーバー側ハンドリング方針

- ユーザーごとの「購読チャンネル ID リスト」をサーバーで状態管理。
  - WS 接続時、または join/leave イベント受信時に購読状態を更新。
- イベント配信時は「チャンネル ID ごとに購読しているユーザーリスト」を参照し、適切に振り分ける。
  - typing: そのチャンネルを購読しているユーザー**だけ**に即時配信
  - メッセージ新規/編集/削除: **購読中すべてのチャンネルのイベント**を各ユーザーへ配信

## フロントエンドとのプロトコル

- クライアントは「今購読したいチャンネル ID リスト」を明示的にサーバに伝える必要がある（接続時＋タブ/ルーム切り替え時）。
- サーバはその購読状態を活用して、イベント毎に適切な配信先を選出。
- 受信したイベントごとにフロントでは「今開いているチャンネルか」を判定し、即時描画 or 通知バッジ更新等を柔軟に決定。

## まとめ

- **タイピング通知**→ そのチャンネルを購読しているユーザー**だけ**
- **新着メッセージ・編集・削除**→ 購読中のユーザーならすべて対象
- **参加していないチャンネルのイベントはすべて配信しない**
- クライアントは購読チャンネル情報を随時サーバーに通知し、サーバーは購読情報に基づき配信範囲を柔軟に選定
