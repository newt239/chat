# デプロイチェックリスト

このチェックリストは、ConoHa VPSへのデプロイに必要な作業を確認するためのものです。

## 事前準備

### サービス・アカウント

- [ ] ConoHa VPSアカウントの作成
- [ ] GitHubアカウントの準備
- [ ] ドメイン名の取得
- [ ] Wasabiアカウントの作成
- [ ] Wasabi S3バケットの作成

### ローカル環境

- [ ] SSH クライアントのインストール
- [ ] Git のインストール

---

## ConoHa VPS の設定

### VPSインスタンス

- [ ] VPSインスタンスの作成（2GB以上推奨）
- [ ] Ubuntu 24.04 LTSのインストール
- [ ] rootパスワードの設定
- [ ] SSH公開鍵の登録
- [ ] IPアドレスの確認

### DNS設定

- [ ] Aレコードの追加（本番環境）
  - `your-domain.com` → VPSのIPアドレス
- [ ] Aレコードの追加（プレビュー環境、任意）
  - `*.preview.your-domain.com` → VPSのIPアドレス
- [ ] DNS設定の反映確認

---

## サーバーの初期設定

### ユーザー設定

- [ ] SSH接続の確認
- [ ] 作業用ユーザー（deploy）の作成
- [ ] sudo権限の付与
- [ ] deployユーザーでのログイン確認

### パッケージのインストール

- [ ] システムアップデートの実行
- [ ] 必要なパッケージのインストール
  - git
  - curl
  - ca-certificates
  - gnupg
  - lsb-release

### Dockerのインストール

- [ ] DockerのGPGキーの追加
- [ ] Dockerリポジトリの追加
- [ ] Dockerのインストール
- [ ] deployユーザーをdockerグループに追加
- [ ] Docker動作確認

### ディレクトリ設定

- [ ] `/opt/chat` ディレクトリの作成
- [ ] `/opt/chat-preview` ディレクトリの作成
- [ ] ディレクトリの所有者を変更

### リポジトリのクローン

- [ ] GitHubからリポジトリをクローン
- [ ] リポジトリの内容確認

### 環境変数の設定

- [ ] `.env.production` ファイルの作成
- [ ] データベース設定の記入
  - POSTGRES_DB
  - POSTGRES_USER
  - POSTGRES_PASSWORD
  - DATABASE_URL
- [ ] バックエンド設定の記入
  - PORT
  - JWT_SECRET（ランダム生成）
  - CORS_ALLOWED_ORIGINS
- [ ] Wasabi S3設定の記入
  - WASABI_ACCESS_KEY_ID
  - WASABI_SECRET_ACCESS_KEY
  - WASABI_BUCKET_NAME
- [ ] Caddy設定の記入
  - DOMAIN
  - CADDY_EMAIL

### ファイアウォール設定

- [ ] UFWのインストール
- [ ] SSH（22）の許可
- [ ] HTTP（80）の許可
- [ ] HTTPS（443）の許可
- [ ] ファイアウォールの有効化
- [ ] 設定確認

### 初回デプロイ

- [ ] 環境変数のロード
- [ ] Dockerコンテナの起動
- [ ] ログの確認
- [ ] ブラウザでの動作確認

---

## GitHub Actionsの設定

### SSH鍵の準備

- [ ] SSH鍵ペアの生成
- [ ] 公開鍵の確認
- [ ] 秘密鍵の確認

### サーバーへの公開鍵登録

- [ ] サーバーに公開鍵を追加
- [ ] authorized_keysの権限設定
- [ ] SSH接続テスト

### GitHubのSecrets設定

#### 本番環境用

- [ ] `SSH_PRIVATE_KEY` の登録
- [ ] `SSH_USER` の登録
- [ ] `PRODUCTION_HOST` の登録
- [ ] `PRODUCTION_SSH_PORT` の登録
- [ ] `PRODUCTION_DOMAIN` の登録

#### プレビュー環境用（任意）

- [ ] `PREVIEW_HOST` の登録
- [ ] `PREVIEW_SSH_PORT` の登録

### GitHub Actionsの動作確認

- [ ] mainブランチへのプッシュ
- [ ] GitHub Actionsの実行確認
- [ ] デプロイ完了の確認
- [ ] ブラウザでの動作確認

---

## セキュリティ設定

### SSH接続の強化

- [ ] SSH設定ファイルの編集
- [ ] rootログインの無効化
- [ ] パスワード認証の無効化
- [ ] SSHサービスの再起動

### セキュリティアップデート

- [ ] 定期的なシステムアップデートの計画
- [ ] Dockerイメージのアップデート計画

---

## バックアップ設定

### データベースバックアップ

- [ ] バックアップディレクトリの作成
- [ ] 手動バックアップの実行テスト
- [ ] バックアップファイルの確認
- [ ] 古いバックアップの削除スクリプト確認

### 自動バックアップ

- [ ] cronの設定
- [ ] 自動バックアップの動作確認

### リストアテスト

- [ ] バックアップからのリストア手順の確認
- [ ] リストアテストの実行（テスト環境）

---

## パフォーマンス最適化

### Docker設定

- [ ] ログローテーションの設定
- [ ] Dockerサービスの再起動
- [ ] ログサイズの確認

### リソース監視

- [ ] docker statsでのリソース確認
- [ ] システムリソースの確認
- [ ] 監視ツールの導入検討

---

## 運用準備

### ドキュメント確認

- [ ] デプロイ手順書の確認
- [ ] トラブルシューティングガイドの確認
- [ ] バックアップ・リストア手順の確認

### 緊急対応手順

- [ ] サーバーダウン時の対応手順
- [ ] データベース障害時の対応手順
- [ ] ロールバック手順の確認

### 監視・アラート

- [ ] サーバー監視の設定
- [ ] アラート通知の設定
- [ ] ログ監視の設定

---

## プレビュー環境のテスト

### デプロイテスト

- [ ] 新しいブランチの作成
- [ ] 変更のコミット
- [ ] ブランチへのプッシュ
- [ ] GitHub Actionsの実行確認
- [ ] プレビュー環境の動作確認

### クリーンアップテスト

- [ ] プレビュー環境の削除
- [ ] リソースの解放確認

---

## 最終確認

### 本番環境

- [ ] HTTPSでのアクセス確認
- [ ] SSL証明書の確認
- [ ] すべての機能の動作確認
- [ ] パフォーマンステスト
- [ ] セキュリティスキャン

### GitHub Actions

- [ ] mainブランチへの自動デプロイ確認
- [ ] プレビュー環境の自動作成確認
- [ ] デプロイログの確認

### ドキュメント

- [ ] README.mdの更新
- [ ] デプロイ手順書の最終確認
- [ ] チームメンバーへの共有

---

## 定期メンテナンス計画

### 毎日

- [ ] アプリケーションログの確認
- [ ] システムリソースの確認

### 毎週

- [ ] セキュリティアップデートの確認
- [ ] バックアップファイルの確認
- [ ] ディスク容量の確認

### 毎月

- [ ] システムアップデートの実行
- [ ] Dockerイメージの更新
- [ ] 不要なプレビュー環境の削除
- [ ] バックアップからのリストアテスト

### 四半期

- [ ] セキュリティ監査
- [ ] パフォーマンスレビュー
- [ ] インフラコストの見直し

---

## トラブル発生時の連絡先

- 開発チーム: `<チームの連絡先>`
- インフラ担当: `<担当者の連絡先>`
- ConoHaサポート: https://www.conoha.jp/support/

---

## 参考資料

- [デプロイ手順書](./deployment.md)
- [バックエンドアーキテクチャ](./backend-architecture.md)
- [Docker公式ドキュメント](https://docs.docker.com/)
- [GitHub Actions公式ドキュメント](https://docs.github.com/actions)
- [Caddy公式ドキュメント](https://caddyserver.com/docs/)
